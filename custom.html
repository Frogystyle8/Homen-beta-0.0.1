<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Custom â€” Create Room</title>
<style>
  body{font-family:system-ui,Arial;background:#071018;color:#e6eef6;display:flex;align-items:center;justify-content:center;height:100vh;margin:0}
  .card{background:#0b1720;padding:20px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.6);width:420px}
  input,button{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071018;color:#e6eef6}
  .row{display:flex;gap:8px}
  .small{font-size:13px;color:#9fb6c6;margin-top:8px}
</style>
</head>
<body>
  <div class="card" role="main">
    <h2>Create or Join Room</h2>
    <label>Room code (optional)</label>
    <input id="roomInput" placeholder="Leave empty to create new room" />
    <label>Game username</label>
    <input id="gameName" placeholder="Your in-game name" />
    <div class="row">
      <button id="createBtn">Create Room</button>
      <button id="joinBtn">Join Room</button>
    </div>
    <div class="small" id="status">Signed-in user will be used as owner/member.</div>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, set, update, get, push } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD8Vz9WCsGwvs8a3hm0smPFysM0lMnF2uY",
  authDomain: "data-c6b63.firebaseapp.com",
  databaseURL: "https://data-c6b63-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "data-c6b63",
  storageBucket: "data-c6b63.firebasedestorage.app",
  messagingSenderId: "473217478100",
  appId: "1:473217478100:web:e9508960991a17dfa1fa41",
  measurementId: "G-8P4JRVVCTR"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const roomInput = document.getElementById('roomInput');
const createBtn = document.getElementById('createBtn');
const joinBtn = document.getElementById('joinBtn');
const gameNameInput = document.getElementById('gameName');
const statusEl = document.getElementById('status');

let currentUser = null;

// Ensure user is signed in (anonymous fallback)
onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    statusEl.textContent = `Signed in as ${user.uid}`;
  } else {
    // sign in anonymously if not signed in
    signInAnonymously(auth).catch(e => {
      console.error(e);
      statusEl.textContent = 'Auth error';
    });
  }
});

// Utility: generate short room code
function makeRoomCode(len = 6){
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s = '';
  for (let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
  return s;
}

// Create room and redirect to game.html?room=CODE
createBtn.addEventListener('click', async () => {
  const owner = currentUser ? currentUser.uid : null;
  const ownerGameName = (gameNameInput.value || '').trim() || (owner ? owner.slice(0,6) : 'Player');
  const roomCode = makeRoomCode(6);
  const roomRef = ref(db, `rooms/${roomCode}`);
  try {
    await set(roomRef, {
      createdAt: Date.now(),
      owner,
      ownerGameName,
      startAt: null,
      started: false,
      maxPlayers: 8
    });
    // add owner as member
    await set(ref(db, `rooms/${roomCode}/members/${owner}`), {
      uid: owner,
      gameName: ownerGameName,
      x: 1800, y: 900,
      ready: true,
      caught: false,
      transformed: false,
      isBot: false
    });
    // redirect including room code
    window.location.href = `game.html?room=${encodeURIComponent(roomCode)}`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Create failed';
  }
});

// Join existing room (redirect with room param)
joinBtn.addEventListener('click', async () => {
  const code = (roomInput.value || '').trim().toUpperCase();
  if (!code) { statusEl.textContent = 'Enter room code or create a new room'; return; }
  try {
    const snap = await get(ref(db, `rooms/${code}`));
    if (!snap.exists()) { statusEl.textContent = 'Room not found'; return; }
    // write member entry (so game will see us)
    const owner = currentUser ? currentUser.uid : null;
    const name = (gameNameInput.value || '').trim() || (owner ? owner.slice(0,6) : 'Player');
    await set(ref(db, `rooms/${code}/members/${owner}`), {
      uid: owner,
      gameName: name,
      x: 1800, y: 900,
      ready: true,
      caught: false,
      transformed: false,
      isBot: false
    });
    window.location.href = `game.html?room=${encodeURIComponent(code)}`;
  } catch (err) {
    console.error(err);
    statusEl.textContent = 'Join failed';
  }
});
</script>
</body>
  </html>
